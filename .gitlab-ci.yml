stages:
- test
- compile_project
- build_docker_image
- deploy_to_servers
- manual_deploy_to_servers

variables:
  GIT_SSL_NO_VERIFY: "true"
  RANCHER_DEV_URL: "http://10.141.11.53:8080"
  RANCHER_PROD_URL: "http://10.120.12.41:8080"
  HTTP_PROXY_FOR_PROD: "http://10.120.12.56:3128"
  HTTPS_PROXY_FOR_PROD: "http://10.120.12.56:3128"
  HTTP_PROXY_FOR_DEV: "http://10.141.11.57:3128"
  HTTPS_PROXY_FOR_DEV: "http://10.141.11.57:3128"
  RANCHER_REST_WRAPPER_IMAGE: $CI_REGISTRY/integrations/ihub-grid/rancher-rest-wrapper:master
  CONTAINER_PHP_FPM_IMAGE_MASTER: $CI_REGISTRY/integrations/ihub-grid/ihub-sw-infrastructure:php-fpm-master
  CONTAINER_PHP_FPM_IMAGE_DEV: $CI_REGISTRY/integrations/ihub-grid/ihub-sw-infrastructure:php-fpm-dev
  CONTAINER_CODE_IMAGE: $CI_REGISTRY/integrations/ihub-grid/ihub-sw:$CI_BUILD_REF_NAME
  NEWRELIC_DEPLOYMENT_API_KEY: "72add31ff74c0f5d4e8fc61ba1c38ac38bdb0e6dc9f226e"
  NEWRELIC_DEPLOYMENT_APP_ID_DEV: "44669872"
  NEWRELIC_DEPLOYMENT_APP_ID_PROD: "42805419"


#====================== templates ======================#
.template_dev: &template_dev
  tags:
    - de2gl03d_dind_1
  only:
    - dev

.template_prod: &template_prod
  tags:
    - de2gl03p_dind_1
  only:
    - master
    - tags

.template_add_ssh_auth: &template_add_ssh_auth
  before_script:
    - mkdir ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - git config core.sshCommand "ssh -i ~/.ssh/id_rsa -F /dev/null"
    - echo "$COMPOSER_INSTALL_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa || true

.template_compile_n_test: &template_compile_n_test
  <<: *template_dev
  <<: *template_add_ssh_auth
  stage: test
  image: $CONTAINER_PHP_FPM_IMAGE_DEV
#  cache:
#    key: $CI_BUILD_REF_NAME
#    untracked: true
#    paths:
#      - ./vendor
  artifacts:
    when: on_failure
    name: $CI_BUILD_REF_NAME
    paths:
      - ./tests/_output
      - ./storage/logs
      - ./.env.testing
    expire_in: 1 hour

# build_docker_image
.template_build_docker_image: &template_build_docker_image
  stage: build_docker_image
  image: docker:latest
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN gitlab.favorit:4567
    - rm -rf .git .gitlab-ci.yml .gitignore .env.example ./run
    - docker build -t $CONTAINER_CODE_IMAGE .
    - docker push $CONTAINER_CODE_IMAGE

.template_build_docker_image_dev: &template_build_docker_image_dev
  <<: *template_dev
  <<: *template_build_docker_image

.template_build_docker_image_prod: &template_build_docker_image_prod
  <<: *template_prod
  <<: *template_build_docker_image
# END build_docker_image

# deploy_to_servers
.template_deploy: &template_deploy
  stage: deploy_to_servers
  image: $RANCHER_REST_WRAPPER_IMAGE

.template_deploy_dev: &template_deploy_dev
  <<: *template_dev
  <<: *template_deploy
  only:
    - dev

.template_deploy_prod: &template_deploy_prod
  <<: *template_prod
  <<: *template_deploy
  only:
    - tags
    - master
  when: manual
# END deploy_to_servers

#====================== templates ======================#

fail_build_for_incorrect_branches:
  tags:
    - de2gl03d_dind_1
  stage: test
  script:
    - echo "Not corrected branch name. You should pass /^(?![a-zA-Z]{1,6}-[0-9]{1,4}-).*$/"
    - exit 1
  only:
    - /^(?![a-zA-Z]{1,6}-[0-9]{1,4}-).*$/
  except:
    - dev
    - master
    - tags

test_feature:
  <<: *template_compile_n_test
  script:
    - export http_proxy=$HTTP_PROXY_FOR_DEV
    - export https_proxy=$HTTPS_PROXY_FOR_DEV
    - bash ./run/dev/make-configs.sh
    - chmod -Rf 777 ./storage && chmod -Rf 777 ./bootstrap/cache && chmod -Rf 777 ./public/images || true
    - composer install --optimize-autoloader
    - php artisan migrate
    - ./vendor/bin/codecept run
  only:
    - /^[a-zA-Z]{1,6}-[0-9]{1,4}-.*$/

test_on_dev_conf_prod:
  <<: *template_compile_n_test
  image: $CONTAINER_PHP_FPM_IMAGE_MASTER
  script:
    - export http_proxy=$HTTP_PROXY_FOR_DEV
    - export https_proxy=$HTTPS_PROXY_FOR_DEV
    - chmod -Rf 777 ./storage && chmod -Rf 777 ./bootstrap/cache && chmod -Rf 777 ./public/images || true
    - bash ./run/prod/make-configs-for-tests.sh
    - composer install --optimize-autoloader
    - ./vendor/bin/codecept run --fail-fast
  only:
    - master
    - tags

test_on_dev_conf_prod_e2e:
  <<: *template_compile_n_test
  image: $CONTAINER_PHP_FPM_IMAGE_MASTER
  allow_failure: true
  script:
    - export http_proxy=$HTTP_PROXY_FOR_DEV
    - export https_proxy=$HTTPS_PROXY_FOR_DEV
    - chmod -Rf 777 ./storage && chmod -Rf 777 ./bootstrap/cache && chmod -Rf 777 ./public/images || true
    - bash ./run/prod/make-configs-for-tests-mocks-off.sh
    - composer install --optimize-autoloader
    - ./vendor/bin/codecept run --fail-fast
  when: manual
  only:
    - master
    - tags
    - dev

compile_dev:
  <<: *template_dev
  <<: *template_add_ssh_auth
  stage: compile_project
  image: $CONTAINER_PHP_FPM_IMAGE_DEV
  script:
    - export http_proxy=$HTTP_PROXY_FOR_DEV
    - export https_proxy=$HTTPS_PROXY_FOR_DEV
    - bash ./run/dev/make-configs.sh
    - chmod -R 777 ./storage && chmod -R 777 ./bootstrap/cache && chmod -R 777 ./public/images || true
    - composer install --optimize-autoloader
    - php artisan migrate
  cache:
    key: $CI_BUILD_REF_NAME
    paths:
      - ./vendor
  artifacts:
    paths:
      - ./vendor
      - ./
    expire_in: 1 hour
  only:
    - dev

compile_prod:
  <<: *template_prod
  <<: *template_add_ssh_auth
  stage: compile_project
  image: $CONTAINER_PHP_FPM_IMAGE_MASTER
  script:
    - git log --oneline $(git for-each-ref --sort=taggerdate --format '%(tag)' | tail -1)..HEAD | grep ".* Merge branch '[a-zA-Z]\{1,6\}-[0-9]\{1,4\}-.*' into 'master'" || true
    - export http_proxy=$HTTP_PROXY_FOR_PROD
    - export https_proxy=$HTTPS_PROXY_FOR_PROD
    - rm -rf .env .env.testing ./tests .git
    - chmod -Rf 777 ./storage && chmod -Rf 777 ./bootstrap/cache && chmod -Rf 777 ./public/images || true
    - bash ./run/prod/decode.sh
    - bash ./run/prod/make-configs.sh
    - composer install --optimize-autoloader
    - php artisan route:cache
    - rm -rf ./run/prod/make-configs.sh
  cache:
    key: $CI_BUILD_REF_NAME
    paths:
      - ./vendor
  artifacts:
    paths:
      - ./vendor
      - ./
    expire_in: 1 hour
  only:
    - master
    - tags

build_docker_image_dev:
  <<: *template_build_docker_image_dev
  only:
    - dev

build_docker_image_prod:
  <<: *template_build_docker_image_prod
  only:
    - master
    - tags

deploy_to_servers_dev:
  <<: *template_deploy_dev
  script:
    - export http_proxy=$HTTP_PROXY_FOR_DEV
    - export https_proxy=$HTTPS_PROXY_FOR_DEV
    - apk add --update curl
    - export RANCHER_URL=$RANCHER_DEV_URL && export RANCHER_ACCESS_KEY=$RANCHER_DEV_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_DEV_SECRET_KEY
    - upgrade --environment dev-ihub --stack ihub --service php-fpm --new-sidekicks0-image $CONTAINER_CODE_IMAGE
    - upgrade --environment dev-ihub --stack ihub --service nginx --new-sidekicks0-image $CONTAINER_CODE_IMAGE
    - >-
      curl -X POST "https://api.newrelic.com/v2/applications/${NEWRELIC_DEPLOYMENT_APP_ID_DEV}/deployments.json"
      -H "X-Api-Key:${NEWRELIC_DEPLOYMENT_API_KEY}" -i
      -H 'Content-Type: application/json'
      -d
      "{
      \"deployment\": {
      \"revision\": \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_PIPELINE_ID}\",
      \"changelog\": \"\",
      \"description\": \"https://gitlab.favorit/integrations/ihub-grid/ihub-sw/pipelines/${CI_PIPELINE_ID}\",
      \"user\": \"${GITLAB_USER_EMAIL}\"
      }
      }"

manual_deploy_to_servers_system_prod:
  <<: *template_deploy_prod
  script:
    - export RANCHER_URL=$RANCHER_PROD_URL && export RANCHER_ACCESS_KEY=$RANCHER_PROD_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_PROD_SECRET_KEY
    - upgrade --environment ihub --stack ihub --service php-fpm-system --new-sidekicks0-image $CONTAINER_CODE_IMAGE

#manual_deploy_to_servers_pre_prod:
#  <<: *template_deploy_prod
#  script:
#    - export RANCHER_URL=$RANCHER_PROD_URL && export RANCHER_ACCESS_KEY=$RANCHER_PROD_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_PROD_SECRET_KEY
#    - upgrade --environment ihub --stack ihub --service php-fpm-pre-prod --new-sidekicks0-image $CONTAINER_CODE_IMAGE
#    - upgrade --environment ihub --stack ihub --service nginx-pre-prod --new-sidekicks0-image $CONTAINER_CODE_IMAGE

manual_deploy_to_servers_all_prod:
  <<: *template_deploy_prod
  script:
    - export http_proxy=$HTTP_PROXY_FOR_PROD
    - export https_proxy=$HTTPS_PROXY_FOR_PROD
    - apk add --update curl
    - export RANCHER_URL=$RANCHER_PROD_URL && export RANCHER_ACCESS_KEY=$RANCHER_PROD_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_PROD_SECRET_KEY
    - upgrade --environment ihub --stack ihub --service php-fpm --new-sidekicks0-image $CONTAINER_CODE_IMAGE
    - upgrade --environment ihub --stack ihub --service nginx --new-sidekicks0-image $CONTAINER_CODE_IMAGE
    - upgrade --environment ihub --stack ihub --service php-fpm-system --new-sidekicks0-image $CONTAINER_CODE_IMAGE
#    - upgrade --environment ihub --stack ihub --service php-fpm-pre-prod --new-sidekicks0-image $CONTAINER_CODE_IMAGE
#    - upgrade --environment ihub --stack ihub --service nginx-pre-prod --new-sidekicks0-image $CONTAINER_CODE_IMAGE
    - >-
      curl -X POST "https://api.newrelic.com/v2/applications/${NEWRELIC_DEPLOYMENT_APP_ID_PROD}/deployments.json"
      -H "X-Api-Key:${NEWRELIC_DEPLOYMENT_API_KEY}" -i
      -H 'Content-Type: application/json'
      -d
      "{
      \"deployment\": {
      \"revision\": \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_PIPELINE_ID}\",
      \"changelog\": \"\",
      \"description\": \"https://gitlab.favorit/integrations/ihub-grid/ihub-sw/pipelines/${CI_PIPELINE_ID}\",
      \"user\": \"${GITLAB_USER_EMAIL}\"
      }
      }"
  only:
    - tags
