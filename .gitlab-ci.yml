stages:
- test
- build
- deploy
- upgrade

variables:
  GIT_SSL_NO_VERIFY: "true"
  RANCHER_DEV_URL: "http://10.141.11.53:8080"
  RANCHER_PROD_URL: "http://10.120.12.41:8080"
  CONTAINER_IHUB_CODE_IMAGE: $CI_REGISTRY/integrations/ihub:$CI_BUILD_REF_NAME

build_and_test:
  tags:
    - de2gl03d_dind_1
  stage: test
  image: gitlab.favorit:4567/integrations/docker:php-fpm-dev
  services:
    - redis:3.2
  script:
    - bash ./run/dev/install-rancher.sh
    - ./vendor/bin/codecept run
  cache:
    key: $CI_BUILD_REF_NAME
    untracked: true
    paths:
      - ./vendor
  artifacts:
    when: on_failure
    name: $CI_BUILD_REF_NAME
    paths:
      - ./tests/_output
      - ./storage/logs
      - ./.env.testing
    expire_in: 1 day
  only:
    - /^ihub-[0..9]{1,3}.*$/

build_test_on_dev_env_prod:
  tags:
    - de2gl03d_dind_1
  stage: test
  image: gitlab.favorit:4567/integrations/docker:php-fpm-dev
  services:
    - redis:3.2
  script:
    - bash ./run/prod/tests.sh
  cache:
    key: $CI_BUILD_REF_NAME
    untracked: true
    paths:
      - ./vendor
  artifacts:
    when: on_failure
    name: $CI_BUILD_REF_NAME
    paths:
      - ./tests/_output
      - ./storage/logs
      - ./.env.testing
    expire_in: 1 day
  only:
    - master

build_dev:
  tags:
    - de2gl03d_dind_1
  stage: build
  image: gitlab.favorit:4567/integrations/docker:php-fpm-dev
  script:
    - rm -rf .env .env.testing
    - bash ./run/dev/install-rancher.sh
  cache:
    key: $CI_BUILD_REF_NAME
    paths:
      - ./vendor
  artifacts:
    paths:
      - ./vendor
      - ./
    expire_in: 1 week
  only:
    - dev

build_prod:
  tags:
    - de2gl03p_dind_1
  stage: build
  image: gitlab.favorit:4567/integrations/docker:php-fpm-master
  script:
    - export http_proxy="http://10.120.12.56:3128"
    - export https_proxy="http://10.120.12.56:3128"
    - rm -rf .env .env.testing
    - bash ./run/prod/decode.sh
    - bash ./run/prod/install-rancher.sh
    - cat /root/ihub/env.ihub >> .env
  cache:
    key: $CI_BUILD_REF_NAME
    paths:
      - ./vendor
  artifacts:
    paths:
      - ./vendor
      - ./
    expire_in: 1 week
  only:
    - master

push_code_dev:
  tags:
    - de2gl03d_dind_1
  stage: deploy
  image: docker:latest
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN gitlab.favorit:4567
    - rm -rf .git .gitlab-ci.yml .gitignore .env.example ./run
    - docker build -t $CONTAINER_IHUB_CODE_IMAGE .
    - docker push $CONTAINER_IHUB_CODE_IMAGE
  only:
    - dev

push_code_prod:
  tags:
    - de2gl03p_dind_1
  stage: deploy
  image: docker:latest
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN gitlab.favorit:4567
    - rm -rf .git .gitlab-ci.yml .gitignore .env.example ./run
    - docker build -t $CONTAINER_IHUB_CODE_IMAGE .
    - docker push $CONTAINER_IHUB_CODE_IMAGE
  only:
    - master

rancher_upgrade_dev:
  tags:
    - de2gl03d_dind_1
  stage: upgrade
  image: gitlab.favorit:4567/integrations/rancher-rest-wrapper:master
  script:
    - export RANCHER_URL=$RANCHER_DEV_URL && export RANCHER_ACCESS_KEY=$RANCHER_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_SECRET_KEY
    - upgrade --environment dev-ihub --stack ihub --service php-fpm
    - upgrade --environment dev-ihub --stack ihub --service nginx
  only:
    - dev

manual_dev_push_code:
  tags:
    - de2gl03d_dind_1
  stage: deploy
  image: docker:latest
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN gitlab.favorit:4567
    - rm -rf .git .gitlab-ci.yml .gitignore .env.example
    - ls -liah
    - docker build -t $CONTAINER_IHUB_CODE_IMAGE .
    - docker push $CONTAINER_IHUB_CODE_IMAGE
  only:
    - dev
  when: manual

manual_dev_rancher_upgrade:
  tags:
    - de2gl03d_dind_1
  stage: upgrade
  image: gitlab.favorit:4567/integrations/rancher-rest-wrapper:master
  script:
    - export RANCHER_URL=$RANCHER_DEV_URL && export RANCHER_ACCESS_KEY=$RANCHER_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_SECRET_KEY
    - upgrade --environment dev-ihub --stack ihub --service php-fpm
    - upgrade --environment dev-ihub --stack ihub --service nginx
  only:
    - dev
  when: manual

manual_prod_rancher_upgrade:
  tags:
    - de2gl03p_dind_1
  stage: upgrade
  image: gitlab.favorit:4567/integrations/rancher-rest-wrapper:master
  script:
    - export RANCHER_URL=$RANCHER_PROD_URL && export RANCHER_ACCESS_KEY=$RANCHER_PROD_ACCESS_KEY && export RANCHER_SECRET_KEY=$RANCHER_PROD_SECRET_KEY
    - upgrade --environment ihub --stack ihub --service php-fpm
    - upgrade --environment ihub --stack ihub --service nginx
    - upgrade --environment ihub --stack ihub --service php-fpm-system
  only:
    - master
  when: manual